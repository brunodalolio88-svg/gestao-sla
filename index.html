export default {
  async fetch(request, env) {
    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS, DELETE",
      "Access-Control-Allow-Headers": "Content-Type, Authorization",
    };

    if (request.method === "OPTIONS") return new Response(null, { headers: corsHeaders });

    // 1. VERIFICAÇÃO DE SEGURANÇA PADRÃO
    const authHeader = request.headers.get("Authorization");
    if (!authHeader || !authHeader.startsWith("Basic ")) {
        return new Response("Não autorizado: Cabeçalho faltando ou inválido", { status: 401, headers: corsHeaders });
    }

    try {
      // Decodifica a senha (Padrão Basic Auth)
      const base64 = authHeader.split(' ')[1];
      const decoded = atob(base64);
      const [user, pass] = decoded.split(':');

      // Verifica no Banco
      const authCheck = await env.DB.prepare("SELECT * FROM usuarios WHERE username = ? AND password = ?")
        .bind(user, pass).first();

      if (!authCheck) return new Response("Login ou Senha incorretos", { status: 401, headers: corsHeaders });

      const url = new URL(request.url);

      // --- ROTAS DO SISTEMA ---

      if (request.method === "POST" && url.pathname === "/save_bulk") {
        const items = await request.json();
        const statements = items.map(d => env.DB.prepare("INSERT OR REPLACE INTO demandas (id, dados) VALUES (?, ?)").bind(`${d.reqc}_${d.item}`, JSON.stringify(d)));
        await env.DB.batch(statements);
        return new Response("OK", { headers: corsHeaders });
      }

      if (request.method === "DELETE" && url.pathname === "/clear_active") {
        const { results } = await env.DB.prepare("SELECT id, dados FROM demandas").all();
        const toDelete = results.filter(row => !JSON.parse(row.dados).status_final).map(row => row.id);
        if (toDelete.length > 0) {
            for (let i = 0; i < toDelete.length; i += 10) {
                const batch = toDelete.slice(i, i + 10).map(id => env.DB.prepare("DELETE FROM demandas WHERE id = ?").bind(id));
                await env.DB.batch(batch);
            }
        }
        return new Response("OK", { headers: corsHeaders });
      }

      if (request.method === "POST" && url.pathname === "/save_user") {
        const u = await request.json();
        await env.DB.prepare("INSERT OR REPLACE INTO usuarios (username, password) VALUES (?, ?)").bind(u.username, u.password).run();
        return new Response("OK", { headers: corsHeaders });
      }

      if (request.method === "POST" && url.pathname === "/save") {
        const d = await request.json();
        await env.DB.prepare("INSERT OR REPLACE INTO demandas (id, dados) VALUES (?, ?)").bind(`${d.reqc}_${d.item}`, JSON.stringify(d)).run();
        return new Response("OK", { headers: corsHeaders });
      }

      if (request.method === "GET" && url.pathname === "/list") {
        const { results } = await env.DB.prepare("SELECT dados FROM demandas").all();
        const list = results.map(row => JSON.parse(row.dados));
        return new Response(JSON.stringify(list), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
      }

      return new Response("Rota não encontrada", { status: 404, headers: corsHeaders });

    } catch (err) {
      return new Response("Erro Worker: " + err.message, { status: 500, headers: corsHeaders });
    }
  }
};
